= Архитектура система

У овом поглављу описана је архитектура развијеног система кроз две целине. Најпре је представљен концептуални модел решења, који приказује логичку организацију система, његове главне компоненте и односе између њих. Након тога дат је преглед кључних функционалности _framework_-а, које описују токове надзора сервиса, ажурирање њиховог стања, руковање неуспесима, евидентирање метрика и генерисање алармних сигнала.

== Концептуални модел система

Архитектура система организована је тако да јасно раздваја кључне функционалности и омогућава једноставно проширивање и одржавање решења. У основи, систем се састоји од конфигурационог слоја, централног _framework_-а за надзор, сервиса који се проверавају и компоненти за метрике и аларме. Ове целине међусобно сарађују кроз једноставне и добро дефинисане токове података. На слици #link(<fig:system_high_level>)[4] приказан је концептуални модел система.

#figure(image("../slike/system_high_level.png", width: 70%),
  caption: [
    Концептуални модел система. 
  ]
)<fig:system_high_level>

=== Конфигурациони слој
Конфигурациони слој представља улазну тачку система у којој се дефинишу сви релевантни параметри надзора. У њему се наводе сервиси који се прате, типови провера које треба извршавати, интервали и прагови на основу којих се доносе одлуке о исправности. Овај слој омогућава да се понашање система прилагоди различитим окружењима без потребе за изменама у самом _framework_-у, чиме се постиже флексибилност и лако одржавање.

=== Health-check framework
_Health-check framework_ представља језгро система и задужен је за извршавање свих операција надзора. На основу учитане конфигурације, овај модул иницира периодичне провере, обрађује резултате добијене од сервиса и одређује у ком се стању рада они налазе. У оквиру овог модула доносе се и одлуке о покретању корективних акција, попут поновног покретања сервиса. _Framework_ функционише као централни чвор који координише интеракцију између свих осталих компоненти система.

#pagebreak()

=== Сервиси који се проверавају
Сервиси који се проверавају представљају апликације, микросервисе или друге функционалне јединице чије је здравље предмет праћења. _Framework_ се периодично повезује са сваким сервисом како би утврдио да ли он функционише у очекиваном режиму. На основу добијене повратне информације, _framework_ процењује доступност, исправност и стање сваке јединице. У концептуалном моделу сервиси су логички груписани у оквиру извршног окружења, али остају независни од конкретне технологије или платформе на којој се извршавају.

=== Компоненте за метрике и аларме
Компонента за метрике служи за бележење информација о успешно или неуспешно извршеним проверама, као и о променама у стању сервиса током времена. Ове информације представљају основу за каснију анализу понашања система и могу се користити за визуелизацију или праћење историје стабилности. Поред тога, _framework_ генерише и алармне сигнале који указују на критичне проблеме, као што су већи број узастопних неуспеха или потпуна недоступност сервиса. Метрике и аларми представљају излазни слој система и не зависе од конкретног механизма за њихову даљу обраду.

== Функционалности система

У наставку су издвојене кључне функционалности које _framework_ реализује. Оне представљају основне токове извршавања у оквиру система и описују на који начин _framework_ учитава конфигурацију, покреће периодичне провере, обрађује резултате, доноси одлуке о стању сервиса и иницира корективне мере када је то неопходно. У табели #link(<tbl:functionalnosti>)[1] дат је преглед свих функционалности на високом нивоу и њихови описи.

#figure(
  table(
    columns: 2,
    align: (col, row) => (left,left).at(col),
    inset: 6pt,
    [Функционалност], [Опис],
    [Иницијализација система], [_Framework_ чита _YAML_ фајл, поставља почетна стања и припрема компоненте за рад.],
    [Извршавање _health-check_ циклуса], [_Framework_ периодично упућује захтеве дефинисаним сервисима како би проверио њихову доступност.],
    [Обрада резултата провере], [Одговори добијени од сервиса анализирају се како би се утврдила успешност провера.],
    [Управљање животним циклусом сервиса], [На основу резултата _framework_ ажурира тренутно стање посматраног сервиса.],
    [Руковање неуспесима и покретање корективних акција], [Када се детектује више узастопних неуспеха, _framework_ активира корективне мере.],
    [Генерисање и бележење метрика], [Током рада система бележе се метрике о успесима, неуспесима и променама стања сервиса, које се користе за анализу система.],
    [Генерисање аларма], [При критичним стањима или продуженој недоступности сервиса _framework_ генерише аларме.]
  ),
  caption: [Преглед функционалности _Health-check framework_-a]
)<tbl:functionalnosti>

#pagebreak()

=== Иницијализација система

_Framework_ се покреће на основу конфигурационе датотеке у _YAML_ формату коју је дефинисао корисник или администратор, а чија је логичка 
структура приказана у табели #link(<tbl:yaml_konfiguracija>)[2]. Након покретања, _framework_ приступа конфигурацији и преузима податке о сервисима који се надзиру, 
врстама провера које треба да се извршавају и параметрима који одређују понашање система. _Config Loader_ учитава садржај конфигурације, валидира структуру и припрема 
све неопходне информације за даљу употребу. _Health-check framework_ затим обрађује преузете податке, иницијализује своје унутрашње компоненте, поставља почетна стања 
сервиса и припрема систем за извршавање периодичних _health-check_ циклуса. На слици #link(<fig:config_diagram>)[5] приказан је дијаграм секвенце који илуструје 
описани ток учитавања конфигурације и иницијализације система.

#figure(
  table(
    columns: 2,
    align: (col, row) => (left, left).at(col),
    inset: 6pt,
    [Параметар], [Опис],
    [_containers_],
    [Листа сервиса који се надзиру. Сваки елемент садржи назив сервиса и параметре провера.],
    [_name_],
    [Јединствени идентификатор сервиса у оквиру система надзора.],
    [_startupProbe_ / _livenessProbe_ / _readinessProbe_],
    [Дефиниције различитих типова провера које се извршавају над сервисом.],
    [_httpGet_ / _tcpSocket_ / _grpcCheck_],
    [Параметри специфични за изабрани метод провере: путања и порт за _HTTP_, порт за _TCP_, назив _gRPC_ сервиса за _gRPC_.],
    [_path_],
    [Рута контролера или endpoint-а на коју се упућује _HTTP_ захтев у циљу провере стања сервиса.],
    [_port_],
    [Порт на којем сервис очекује проверу (важи за све методе).],
    [_host_],
    [Име сервиса или контејнера у оквиру извршног окружења преко кога се успоставља комуникација.],
    [_initialDelaySeconds_],
    [Време које _framework_ чека пре извршавања прве провере одређеног probe-а.],
    [_periodSeconds_],
    [Интервал између узастопних провера током рада система.],
    [_failureThreshold_],
    [Број узастопних неуспеха након којих се сервис сматра неисправним.]
  ),
  caption: [Структура конфигурационе _YAML_ датотеке]
)<tbl:yaml_konfiguracija>

#figure(image("../slike/config_diagram.png", width: auto),
  caption: [
    Дијаграм секвенце који описује ток иницијализације система. 
  ]
)<fig:config_diagram>

=== Извршавање _health-check_ циклусa
_Framework_ периодично покреће _health-check_ циклус у складу са интервалима дефинисаним у конфигурационој датотеци. Током сваког циклуса _framework_ приступа сервисима који су наведени за надзор и одређује врсту провере (_startup_, _liveness_ или _readiness_) као и метод комуникације који је предвиђен за тај сервис (_HTTP_, _TCP_ или _gRPC_). Након припреме параметара провере _framework_ иницира комуникацију упућивањем _health-check_ захтева ка сервису. Сервис затим враћа информацију о свом тренутном стању, као што су доступност или грешка у раду. 

=== Обрада резултата провере
По пријему одговора сервиса, _framework_ приступа интерпретацији добијених података како би одредио исход текуће провере. У овој фази изводи се анализа која класификује резултат као успех или неуспех, без обзира на то који је метод комуникације коришћен. Обрађени резултат се затим бележи у унутрашње структуре _framework_-а и служи као улаз за наредне кораке као што су ажурирање животног циклуса сервиса, генерисање метрика и по потреби, активирање механизама за корективне акције или алармирање.

Извршавање _health-check_ циклуса и обрада резултата представљају две уско повезане фазе које чине једну логичку целину надзора сервиса. Прво се иницира и извршава провера стања сервиса, а затим се добијени резултат тумачи и евидентира као основ за даље одлуке у систему. На слици #link(<fig:health_check_diagam>)[6] приказан је ток који обухвата покретање _health-check_ циклуса, комуникацију са сервисом, као и обраду и бележење резултата провере.

#figure(image("../slike/health_check_diagam.png", width: 45%),
  caption: [
    Дијаграм секвенце који описује ток комуникацијe са сервисом који се надзире.
  ]
)<fig:health_check_diagam>

=== Управљање животним циклусом сервиса 
Након обраде резултата појединачних провера, _framework_ ажурира стање сервиса на основу више узастопних успеха или неуспеха. Оцену не одређује једна провера, већ се посматра понашање сервиса током више узастопних _health-check_ циклуса, како би се разликовале краткотрајне сметње од стварних проблема у раду. На овај начин сервис може бити означен као здрав (енгл. _Healthy_) или нездрав (енгл. _Unhealthy_) у контексту _liveness_ провера, односно као спреман (енгл. _Ready_)  или неспреман (енгл. _NotReady_) у случају _readiness_ провера. Прелазак из једног у друго стање заснива се на праговима дефинисаним у конфигурационој датотеци (броју узастопних неуспеха након којих се сервис сматра неисправним).

#pagebreak()

=== Руковање неуспесима и покретање корективних акција

Након што _framework_ ажурира стање сервиса на основу резултата провера, он паралелно прати и број узастопних неуспеха. Уколико тај број пређе праг дефинисан у конфигурационој датотеци, сервис се означава као _Unhealthy_, а _framework_ активира корективну меру са циљем опоравка сервиса. У овом систему корективна мера подразумева поновно покретања сервиса у оквиру _Docker_ окружења, чиме се омогућава да систем аутоматски реагује на детектовани проблем.

Поступак поновног покретања се спроводи тако што _framework_ упућује команду _Docker_-у да поново покрене одговарајући контејнер. Након рестарта сервис улази у нови _health-check_ ток, где се поново процењује његово стање на основу резултата наредних провера. На слици #link(<fig:health_check_diagam_with_reset>)[7] приказан је дијаграм секвенце који илуструје ток доношења одлука о поновном покретању и наставак health-check циклуса након корективне акције.

#figure(image("../slike/health_check_diagam_with_reset.png", width: 80%),
  caption: [
    Дијаграм секвенце који описује _health-check_ циклус са корективним акцијама.
  ]
)<fig:health_check_diagam_with_reset>


#pagebreak()

=== Генерисање и бележење метрика

Током рада система _framework_ континуирано генерише метрике које описују понашање надзираних сервиса и самог механизма надзора. На основу резултата појединачних провера и ажурираних стања сервиса бележе се, између осталог, информације о броју извршених провера, броју успешних и неуспешних провера по сервису, као и о променама стања (нпр. прелазак из _Healthy_ у _Unhealthy_ или обрнуто). На овај начин се гради историја која омогућава да се уоче обрасци понашања и дугорочни трендови у стабилности система. Овако прикупљене метрике излажу се кроз јединствен интерфејс који може да користи спољашњи систем за надгледање. На слици #link(<fig:metrics>)[8] приказан је дијаграм секвенце који описује циклус генерисања и бележења метрика.

#figure(image("../slike/metrics.png", width: 45%),
  caption: [
    Дијаграм секвенце који описује циклус генерисања и бележења метрика.
  ]
)<fig:metrics>

=== Генерисање аларма
Поред бележења метрика, _framework_ је задужен и за препознавање критичних стања сервиса и генерисање алармних сигнала када је то неопходно. На основу интерног стања сервиса, броја узастопних неуспеха, покушаја поновног покретања или дужине периода недоступности, _framework_ процењује да ли је потребно да се о конкретном проблему обавесте корисници или спољашњи систем за алармирање. Када су услови за аларм испуњени, формира се опис догађаја који садржи релевантне информације (нпр. који сервис је погођен, који је тип проблема и када је настао) и тај опис се прослеђује компоненти задуженој за даље дистрибуирање аларма. На слици #link(<fig:alerts>)[9] приказан је дијаграм секвенце који описује циклус генерисања аларма.

#figure(image("../slike/alerts.png", width: 60%),
  caption: [
    Дијаграм секвенце који описује циклус генерисања аларма.
  ]
)<fig:alerts>